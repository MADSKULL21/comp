var ot=Object.defineProperty;var rt=(s,t,e)=>t in s?ot(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var h=(s,t,e)=>rt(s,typeof t!="symbol"?t+"":t,e);import{I as y}from"./CG1L1sNd.js";import"./CPkq-MRm.js";import{p as at,t as R,a as ct,c as w,r as g,f as F,s as U,g as C}from"./BX4Dnpro.js";import{f as S,a as p,i as ht,s as J}from"./DS607QHn.js";import{i as L}from"./DrMRszh9.js";import{a as lt,b as ut,e as dt,s as pt}from"./Dbls2O6t.js";import{G as K,H as ft}from"./CdDn1YZH.js";import{q as M,s as gt,t as N,p as bt,j as f,v as b}from"./BegIwIKf.js";import{e as mt,f as vt,t as yt,g as St,h as B,i as q,j as wt}from"./BaqqN2bF.js";import{I as k,b as Ct,e as E,w as _t,i as At,n as kt,P as Y}from"./BJQ2FMEW.js";import{h as W,c as Et}from"./CJIe8Wgg.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};s.SENTRY_RELEASE={id:"22f298fe9ac7c9892685cfa634f1dd18037bb1ae"}}catch{}})();try{(function(){var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},t=new s.Error().stack;t&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[t]="b12a3316-3e26-4ec9-9c4e-b5cc65dd414f",s._sentryDebugIdIdentifier="sentry-dbid-b12a3316-3e26-4ec9-9c4e-b5cc65dd414f")})()}catch{}async function*Tt(s){try{for(;;){const{done:t,value:e}=await s.read();if(t)break;yield new TextDecoder().decode(e)}}finally{s.releaseLock()}}var It=(s=>(s.System="system",s.User="user",s.Assistant="assistant",s))(It||{});const ce=new y("ButlerAIClient");class he{constructor(t){this.cloud=t}async evaluate(t,e,n){var a;const o=(a=(await this.cloud.postRaw("ai/stream",{body:{messages:e,system:t,max_tokens:3600,model_kind:"openai"}})).body)==null?void 0:a.getReader();if(!o)return"";const r=[];for await(const u of Tt(o))n(u),r.push(u);return r.join("")}}var Dt=S('<a class="text-15 text-bold link svelte-x4g04"> </a>'),Pt=S('<span class="text-15 text-bold"> </span>'),xt=ht('<svg width="10" height="16" viewBox="0 0 10 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 0.5L1 15.5" stroke="var(--clr-text-3)"></path></svg><!>',1),Ot=S('<div class="breadcrumbs svelte-x4g04"></div>'),Rt=S('<div class="navigation__left svelte-x4g04"><!> <!></div> <!>',1),Ut=S("<nav><!></nav>");const Lt={hash:"svelte-x4g04",code:".navigation.svelte-x4g04 {display:flex;grid-column:full-start / full-end;align-items:center;width:100%;padding:20px 0 24px;gap:16px;}.navigation__left.svelte-x4g04 {display:flex;align-items:center;gap:16px;}.breadcrumbs.svelte-x4g04 {display:flex;align-items:center;gap:10px;}.breadcrumbs.svelte-x4g04 .link:where(.svelte-x4g04) {color:var(--clr-text-2);transition:color var(--transition-fast);}.breadcrumbs.svelte-x4g04 .link:where(.svelte-x4g04):hover {color:var(--clr-text-1);}"};function le(s,t){at(t,!0),lt(s,Lt);var e=Ut();let n;var i=w(e);{var o=a=>{K(a,{markOnly:!0})},r=a=>{var u=Rt(),T=F(u),H=w(T);K(H,{markOnly:!0});var X=U(H,2);{var Z=I=>{var D=Ot();dt(D,23,()=>t.breadcrumbs,P=>P.label,(P,x,et)=>{var V=xt(),st=U(F(V));{var nt=d=>{var l=Dt(),O=w(l,!0);g(l),R(()=>{pt(l,"href",C(x).href),J(O,C(x).label)}),p(d,l)},it=d=>{var l=Pt(),O=w(l,!0);g(l),R(()=>J(O,C(x).label)),p(d,l)};L(st,d=>{C(et)<t.breadcrumbs.length-1?d(nt):d(it,!1)})}p(P,V)}),g(D),p(I,D)};L(X,I=>{t.breadcrumbs&&t.breadcrumbs.length>0&&I(Z)})}g(T);var tt=U(T,2);ft(tt,{}),p(a,u)};L(i,a=>{t.markOnly?a(o):a(r,!1)})}g(e),R(a=>n=ut(e,1,"navigation svelte-x4g04",null,n,a),[()=>({"justify-center":t.markOnly,"justify-between":!t.markOnly})]),p(s,e),ct()}const ue=new y("ChatChannelsService");class de{constructor(t,e){h(this,"httpClient");h(this,"appDispatch");h(this,"chatMessagesInterests",new k(Ct));this.httpClient=t,this.appDispatch=e}getChatChannelInterest(t,e){return this.chatMessagesInterests.findOrCreateSubscribable({projectId:t,changeId:e},async()=>{const n=mt(t,e);this.appDispatch.dispatch(M.addOne({status:"loading",id:n}));try{const i=await this.httpClient.get(`chat_messages/${t}/chats/${e??""}`);i.reverse();const o={status:"found",id:n,value:{id:n,projectId:t,changeId:e,messages:i.map(vt)}};this.appDispatch.dispatch(M.upsertOne(o))}catch(i){this.appDispatch.dispatch(M.addOne(E(i,n)))}}).createInterest()}async refetchChatChannel(t,e){await this.chatMessagesInterests.invalidate({projectId:t,changeId:e})}async sendChatMessage(t){try{await this.httpClient.post(`chat_messages/${t.projectId}/branch/${t.branchId}`,{body:yt(t)}),this.chatMessagesInterests.invalidate({projectId:t.projectId,changeId:t.changeId})}catch(e){console.error("Failed to send chat message",e)}}async patchChatMessage(t){try{await this.httpClient.patch(`chat_messages/${t.projectId}/chat/${t.messageUuid}`,{body:St(t)}),this.chatMessagesInterests.invalidate({projectId:t.projectId,changeId:t.changeId})}catch(e){console.error("Failed to update chat message",e)}}}function Mt(s,t){let e;return async function(...n){return await new Promise(i=>{clearTimeout(e),e=setTimeout(async()=>{await s.apply(this,n),i()},t)})}}async function Nt(s){await new Audio(s).play()}const Wt=Mt(Nt,1e3);var A={logger:typeof console<"u"?console:void 0,WebSocket:typeof WebSocket<"u"?WebSocket:void 0},c={log(...s){this.enabled&&(s.push(Date.now()),A.logger.log("[ActionCable]",...s))}};const v=()=>new Date().getTime(),_=s=>(v()-s)/1e3;class G{constructor(t){this.visibilityDidChange=this.visibilityDidChange.bind(this),this.connection=t,this.reconnectAttempts=0}start(){this.isRunning()||(this.startedAt=v(),delete this.stoppedAt,this.startPolling(),addEventListener("visibilitychange",this.visibilityDidChange),c.log(`ConnectionMonitor started. stale threshold = ${this.constructor.staleThreshold} s`))}stop(){this.isRunning()&&(this.stoppedAt=v(),this.stopPolling(),removeEventListener("visibilitychange",this.visibilityDidChange),c.log("ConnectionMonitor stopped"))}isRunning(){return this.startedAt&&!this.stoppedAt}recordMessage(){this.pingedAt=v()}recordConnect(){this.reconnectAttempts=0,delete this.disconnectedAt,c.log("ConnectionMonitor recorded connect")}recordDisconnect(){this.disconnectedAt=v(),c.log("ConnectionMonitor recorded disconnect")}startPolling(){this.stopPolling(),this.poll()}stopPolling(){clearTimeout(this.pollTimeout)}poll(){this.pollTimeout=setTimeout((()=>{this.reconnectIfStale(),this.poll()}),this.getPollInterval())}getPollInterval(){const{staleThreshold:t,reconnectionBackoffRate:e}=this.constructor,n=Math.pow(1+e,Math.min(this.reconnectAttempts,10)),o=(this.reconnectAttempts===0?1:e)*Math.random();return t*1e3*n*(1+o)}reconnectIfStale(){this.connectionIsStale()&&(c.log(`ConnectionMonitor detected stale connection. reconnectAttempts = ${this.reconnectAttempts}, time stale = ${_(this.refreshedAt)} s, stale threshold = ${this.constructor.staleThreshold} s`),this.reconnectAttempts++,this.disconnectedRecently()?c.log(`ConnectionMonitor skipping reopening recent disconnect. time disconnected = ${_(this.disconnectedAt)} s`):(c.log("ConnectionMonitor reopening"),this.connection.reopen()))}get refreshedAt(){return this.pingedAt?this.pingedAt:this.startedAt}connectionIsStale(){return _(this.refreshedAt)>this.constructor.staleThreshold}disconnectedRecently(){return this.disconnectedAt&&_(this.disconnectedAt)<this.constructor.staleThreshold}visibilityDidChange(){document.visibilityState==="visible"&&setTimeout((()=>{(this.connectionIsStale()||!this.connection.isOpen())&&(c.log(`ConnectionMonitor reopening stale connection on visibilitychange. visibilityState = ${document.visibilityState}`),this.connection.reopen())}),200)}}G.staleThreshold=6;G.reconnectionBackoffRate=.15;var Q={message_types:{welcome:"welcome",disconnect:"disconnect",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]};const{message_types:m,protocols:j}=Q,Bt=j.slice(0,j.length-1),z=[].indexOf;class ${constructor(t){this.open=this.open.bind(this),this.consumer=t,this.subscriptions=this.consumer.subscriptions,this.monitor=new G(this),this.disconnected=!0}send(t){return this.isOpen()?(this.webSocket.send(JSON.stringify(t)),!0):!1}open(){if(this.isActive())return c.log(`Attempted to open WebSocket, but existing socket is ${this.getState()}`),!1;{const t=[...j,...this.consumer.subprotocols||[]];return c.log(`Opening WebSocket, current state is ${this.getState()}, subprotocols: ${t}`),this.webSocket&&this.uninstallEventHandlers(),this.webSocket=new A.WebSocket(this.consumer.url,t),this.installEventHandlers(),this.monitor.start(),!0}}close({allowReconnect:t}={allowReconnect:!0}){if(t||this.monitor.stop(),this.isOpen())return this.webSocket.close()}reopen(){if(c.log(`Reopening WebSocket, current state is ${this.getState()}`),this.isActive())try{return this.close()}catch(t){c.log("Failed to reopen WebSocket",t)}finally{c.log(`Reopening WebSocket in ${this.constructor.reopenDelay}ms`),setTimeout(this.open,this.constructor.reopenDelay)}else return this.open()}getProtocol(){if(this.webSocket)return this.webSocket.protocol}isOpen(){return this.isState("open")}isActive(){return this.isState("open","connecting")}triedToReconnect(){return this.monitor.reconnectAttempts>0}isProtocolSupported(){return z.call(Bt,this.getProtocol())>=0}isState(...t){return z.call(t,this.getState())>=0}getState(){if(this.webSocket){for(let t in A.WebSocket)if(A.WebSocket[t]===this.webSocket.readyState)return t.toLowerCase()}return null}installEventHandlers(){for(let t in this.events){const e=this.events[t].bind(this);this.webSocket[`on${t}`]=e}}uninstallEventHandlers(){for(let t in this.events)this.webSocket[`on${t}`]=function(){}}}$.reopenDelay=500;$.prototype.events={message(s){if(!this.isProtocolSupported())return;const{identifier:t,message:e,reason:n,reconnect:i,type:o}=JSON.parse(s.data);switch(this.monitor.recordMessage(),o){case m.welcome:return this.triedToReconnect()&&(this.reconnectAttempted=!0),this.monitor.recordConnect(),this.subscriptions.reload();case m.disconnect:return c.log(`Disconnecting. Reason: ${n}`),this.close({allowReconnect:i});case m.ping:return null;case m.confirmation:return this.subscriptions.confirmSubscription(t),this.reconnectAttempted?(this.reconnectAttempted=!1,this.subscriptions.notify(t,"connected",{reconnected:!0})):this.subscriptions.notify(t,"connected",{reconnected:!1});case m.rejection:return this.subscriptions.reject(t);default:return this.subscriptions.notify(t,"received",e)}},open(){if(c.log(`WebSocket onopen event, using '${this.getProtocol()}' subprotocol`),this.disconnected=!1,!this.isProtocolSupported())return c.log("Protocol is unsupported. Stopping monitor and disconnecting."),this.close({allowReconnect:!1})},close(s){if(c.log("WebSocket onclose event"),!this.disconnected)return this.disconnected=!0,this.monitor.recordDisconnect(),this.subscriptions.notifyAll("disconnected",{willAttemptReconnect:this.monitor.isRunning()})},error(){c.log("WebSocket onerror event")}};const jt=function(s,t){if(t!=null)for(let e in t){const n=t[e];s[e]=n}return s};class Gt{constructor(t,e={},n){this.consumer=t,this.identifier=JSON.stringify(e),jt(this,n)}perform(t,e={}){return e.action=t,this.send(e)}send(t){return this.consumer.send({command:"message",identifier:this.identifier,data:JSON.stringify(t)})}unsubscribe(){return this.consumer.subscriptions.remove(this)}}class $t{constructor(t){this.subscriptions=t,this.pendingSubscriptions=[]}guarantee(t){this.pendingSubscriptions.indexOf(t)==-1?(c.log(`SubscriptionGuarantor guaranteeing ${t.identifier}`),this.pendingSubscriptions.push(t)):c.log(`SubscriptionGuarantor already guaranteeing ${t.identifier}`),this.startGuaranteeing()}forget(t){c.log(`SubscriptionGuarantor forgetting ${t.identifier}`),this.pendingSubscriptions=this.pendingSubscriptions.filter((e=>e!==t))}startGuaranteeing(){this.stopGuaranteeing(),this.retrySubscribing()}stopGuaranteeing(){clearTimeout(this.retryTimeout)}retrySubscribing(){this.retryTimeout=setTimeout((()=>{this.subscriptions&&typeof this.subscriptions.subscribe=="function"&&this.pendingSubscriptions.map((t=>{c.log(`SubscriptionGuarantor resubscribing ${t.identifier}`),this.subscriptions.subscribe(t)}))}),500)}}class Ht{constructor(t){this.consumer=t,this.guarantor=new $t(this),this.subscriptions=[]}create(t,e){const n=t,i=typeof n=="object"?n:{channel:n},o=new Gt(this.consumer,i,e);return this.add(o)}add(t){return this.subscriptions.push(t),this.consumer.ensureActiveConnection(),this.notify(t,"initialized"),this.subscribe(t),t}remove(t){return this.forget(t),this.findAll(t.identifier).length||this.sendCommand(t,"unsubscribe"),t}reject(t){return this.findAll(t).map((e=>(this.forget(e),this.notify(e,"rejected"),e)))}forget(t){return this.guarantor.forget(t),this.subscriptions=this.subscriptions.filter((e=>e!==t)),t}findAll(t){return this.subscriptions.filter((e=>e.identifier===t))}reload(){return this.subscriptions.map((t=>this.subscribe(t)))}notifyAll(t,...e){return this.subscriptions.map((n=>this.notify(n,t,...e)))}notify(t,e,...n){let i;return typeof t=="string"?i=this.findAll(t):i=[t],i.map((o=>typeof o[e]=="function"?o[e](...n):void 0))}subscribe(t){this.sendCommand(t,"subscribe")&&this.guarantor.guarantee(t)}confirmSubscription(t){c.log(`Subscription confirmed ${t}`),this.findAll(t).map((e=>this.guarantor.forget(e)))}sendCommand(t,e){const{identifier:n}=t;return this.consumer.send({command:e,identifier:n})}}class Vt{constructor(t){this._url=t,this.subscriptions=new Ht(this),this.connection=new $(this),this.subprotocols=[]}get url(){return Ft(this._url)}send(t){return this.connection.send(t)}connect(){return this.connection.open()}disconnect(){return this.connection.close({allowReconnect:!1})}ensureActiveConnection(){if(!this.connection.isActive())return this.connection.open()}addSubProtocol(t){this.subprotocols=[...this.subprotocols,t]}}function Ft(s){if(typeof s=="function"&&(s=s()),s&&!/^wss?:/i.test(s)){const t=document.createElement("a");return t.href=s,t.href=t.href,t.protocol=t.protocol.replace("http","ws"),t.href}else return s}function Jt(s=Kt("url")||Q.default_mount_path){return new Vt(s)}function Kt(s){const t=document.head.querySelector(`meta[name='action-cable-${s}']`);if(t)return t.getAttribute("content")}function qt(s,t){const e=t.replace("http","ws"),n=new URL("cable",e),i=new URLSearchParams;return s&&i.append("token",s),n.search=i.toString(),n.toString()}const pe=new y("PatchEventsService");class fe{constructor(t,e,n,i,o,r){h(this,"httpClient");h(this,"appState");h(this,"appDispatch");h(this,"token");h(this,"patchService");h(this,"websocketBase");h(this,"userId");h(this,"chatSoundUrl");h(this,"patchEventsInterestStore",new k);this.httpClient=t,this.appState=e,this.appDispatch=n,this.token=i,this.patchService=o,this.websocketBase=r}setUserId(t){this.userId=t}setChatSoundUrl(t){this.chatSoundUrl=t}patchEventsInterest(t,e){const n=_t(this.token,void 0,kt(async i=>{await this.fetchInitialPatchEvents(t,e);const o=qt(i,this.websocketBase),r=Jt(o);return r.subscriptions.create({channel:"ChatChannel",change_id:e,project_id:t},{received:a=>{wt(a)&&this.handlePatchEventData(t,e,a)}}),async()=>{r.disconnect()}}));return this.patchEventsInterestStore.findOrCreateSubscribable({projectId:t,changeId:e},()=>{const i=n.subscribe(()=>{});return()=>{i()}}).createInterest()}shouldPlayChatSound(t){var e;return((e=t.user)==null?void 0:e.id)===void 0||this.userId===void 0?!1:t.user.id!==this.userId&&t.eventType==="chat"}handlePatchEventData(t,e,n){const i=B(t,e),o=gt.selectById(this.appState.patchEvents,i);if(!At(o))return;const r=structuredClone(o),a=q(n);a&&(r.value.events.some(u=>u.uuid===a.uuid)||(r.value.events.unshift(a),this.appDispatch.dispatch(N(r))),a.eventType==="patch_version"?this.appDispatch.dispatch(bt.upsertOne({status:"found",id:a.object.changeId,value:a.object})):a.eventType==="issue_status"?this.patchService.refreshPatchWithSections(e):a.eventType==="chat_reaction"&&this.fetchInitialPatchEvents(t,e),this.shouldPlayChatSound(a)&&this.chatSoundUrl&&Wt(this.chatSoundUrl))}async fetchInitialPatchEvents(t,e){try{const n=await this.httpClient.get(`patch_events/${t}/patch/${e}`);n.reverse();const i=n.map(q).filter(r=>!!r),o=Yt(t,e,i);this.appDispatch.dispatch(N(o))}catch(n){this.appDispatch.dispatch(N(E(n,B(t,e))))}}}function Yt(s,t,e){const n=B(s,t);return{status:"found",id:n,value:{id:n,projectId:s,changeId:t,events:e}}}const ge=new y("UserService"),be=new y("NewUserService");class me{constructor(t,e){h(this,"httpClient");h(this,"appDispatch");h(this,"userInterests",new k(Y));h(this,"userByLoginInterests",new k(Y));this.httpClient=t,this.appDispatch=e}getUserInterest(t){return this.userInterests.findOrCreateSubscribable({id:t},async()=>{this.appDispatch.dispatch(f.addOne({status:"loading",id:t}));try{const e=await this.httpClient.post("user_search",{body:{id:t}});if(e.length===0){this.appDispatch.dispatch(f.upsertOne({status:"not-found",id:t}));return}if(e.length!==1)throw new Error(`Expected 1 user, got ${e.length}`);const n=e[0],i=W(n);this.appDispatch.dispatch(f.upsertOne({status:"found",id:t,value:i})),i.login&&this.appDispatch.dispatch(b.upsertOne({status:"found",id:i.login,value:i.id}))}catch(e){this.appDispatch.dispatch(f.addOne(E(e,t)))}}).createInterest()}getUserByLoginInterest(t){return this.userByLoginInterests.findOrCreateSubscribable({login:t},async()=>{try{const e=await this.httpClient.post("user_search",{body:{login:t}});if(e.length===0){this.appDispatch.dispatch(b.upsertOne({status:"not-found",id:t}));return}if(e.length!==1)throw new Error(`Expected 1 user, got ${e.length}`);const n=e[0],i=W(n);this.appDispatch.dispatch(b.upsertOne({status:"found",id:t,value:i.id})),this.appDispatch.dispatch(f.upsertOne({status:"found",id:i.id,value:i}))}catch(e){this.appDispatch.dispatch(b.addOne(E(e,t)))}}).createInterest()}async searchUsers(t){const e=await this.httpClient.post("user_search",{body:t}),n=e.map(W),i=n.map(r=>({status:"found",id:r.id,value:r}));this.appDispatch.dispatch(f.upsertMany(i));const o=n.map(r=>{if(r.login)return{status:"found",id:r.login,value:r.id}}).filter(r=>!!r);return this.appDispatch.dispatch(b.upsertMany(o)),e.map(Et)}}export{he as B,de as C,It as M,le as N,fe as P,me as U,ce as a,ge as b,pe as c,ue as d,be as e};
//# sourceMappingURL=DVpAvUUN.js.map
